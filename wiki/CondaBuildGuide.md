## Build Parallel Preprocessor by Anaconda 

conda package has both c++ binary and python wrapper installed, just like compiling from source by cmake.

### conda recipe: meta.yaml and build scripts

The meta.yaml and build scripts have been provided in the `recipe` folder of this repository.

The package config file `meta.yaml` can be generated by a command, or just adapted from an existing recipe online, e.g. 
<https://github.com/conda/conda-recipes/tree/master/libtiff>
Also note that the compilers used by conda-build can be specified using a `conda_build_config.yaml`.

The build scripts `build.sh` (for Unix-like OS) and `bld.bat` (windows batch file) have the install instruction (cmake is called just as compiling from source code.), install to a tmp prefix, then compressed into a zipped file, i.e. conda package.  

### build conda package

To build conda package, first of all, install anaconda python3 and install necessary packages like `conda-build`, and run the command in the `recipe` folder of this repository: `conda build meta.ymal`

The conda build task is conducted a seperate virtual environment automatically, so is the test(run) process.  
`D:\Software\anaconda3\envs\cf\conda-bld\ppp_1597347412425`
On windows, cmake isntalled to the `base` conda environment can still detect `occt` package installed in the conda-build tmp conda environment.

NOTE: conda will not auto clean those tmp virtual env, user must manually remove the build virtual env.

### build for multiple python versions 

Since python interface module for parallel preprocessor is C-extension, so seperate binary packages are needed for conda python 3.6, 3.7 and 3.8. 
conda build support build for multiple version, by specify `--py` option multiple times.
`conda build --py 3.6 --py 3.7 --py 3.8  recipe` if this does not work,  try 
`conda build recipe --variants "{'python': ['2.7', '3.6'], 'vc': ['9', '14']}"`

After all, variant control is done by the yaml file`conda_build_config.yaml`. If this file does not exists same directory as` meta.yaml`, `conda build` may generate one. real also [Conda multi variant builds](https://medium.com/@MaheshSawaiker/conda-multi-variant-builds-8edc35c215d7)
```yaml
python:
    - 2.7
    - 3.5
    - 3.6
```

### install built local conda package

Where is the generated conda package?   
If testing script passed, the generated conda package, a compressed file, should be copied to the current working directory.  
If test failed, there may be error message:
> Tests failed for ppp-0.3-hdef9aff_2003.tar.bz2 - moving package to D:\Software\anaconda3\envs\cf\conda-bld\broken

After conda build, the built package can be installed:  `conda install --use-local ppp` or equally `conda install -c local ppp`  to install the built pkg. 
`conda install --use-local ppp --dry-run` to test if built package can be found and installed.   `conda verify` may also verify the package without installation.


It is expected binary conda package for parallel-preprocessor will be hosted on github or conda-forge.  After downloaded from github Release, the compressed package file can be installed by the command

```sh
conda install /package-path/package-filename.tar.bz2
```

### upload to conda forge (yet done)

Here is guide from conda-forge website:
> If your package is not on conda-forge yet you can follow their contribution documentation here:  https://conda-forge.org/#add_recipe

The process: fork conda-forge example repo, and push it as a new repo, later the maintainer (pusher) will have the write control on that repo. 

`conda config --set anaconda_upload yes`


### Gitlab CI and github workflow for conda build

https://github.com/conda/conda-gitlab-ci

Use **github Release** to host built binary conda packages, instead of conda-forge for the moment, before conda-forge is ready.

 https://github.com/marketplace/actions/setup-miniconda

 https://github.com/actions/upload-release-asset

github workflow:  how to control visual studio version for “windows-latest”? 


